/*! kschedule - v1.0 - 2013-09-23 10:15:02 AM
* Copyright (c) 2013 Letao; Licensed  */
KISSY.add("gallery/kschedule/1.0/scheduleform",function(a,b,c){function d(a){var b=this;b.init(),d.superclass.constructor.call(b,a)}return a.extend(d,c,{init:function(){var b=this;b.overlay=a.one(a.DOM.create('<div class="J_ScheduleForm schedule-form"></div>')),a.one("body").append(b.overlay),b._addFrame(),b._addEvent()},_addFrame:function(){var a=this,b='<div class="J_FormArrow form-arrow"><div class="arrow arrow-down"></div><div class="arrow arrow-up"></div></div><div class="J_FormBody form-body"></div><a href="javascript:;" class="J_FormClose form-close">X</a>';a.overlay.html(b),a.closeEl=a.overlay.one(".J_FormClose"),a.body=a.overlay.one(".J_FormBody")},_addEvent:function(){var a=this;a.closeEl.on("click",function(){a.hide()})},setContent:function(b){var c=this,d="string"==typeof b?!1:!0;d&&(b=a.one(b).html()),c.body.html(b)},showToTarget:function(b){var c=this,d=b.offset(),e={w:b.outerWidth(),h:b.outerHeight()},f={w:c.overlay.outerWidth(),h:c.overlay.outerHeight()},g={w:a.one(window).width(),h:a.one(window).height()},h={};h.left=d.left+e.w+5,h.top=d.top+(e.h-f.h)/2,h.left+f.w>g.w?(c.overlay.addClass("schedule-form-outside"),h.left=d.left-f.w-5):c.overlay.removeClass("schedule-form-outside"),c.overlay.css(h),c.show()},show:function(){var a=this;a.overlay.show()},hide:function(){var a=this;a.overlay.hide()}},{ATTRS:{}}),d},{requires:["node","base"]}),KISSY.add("gallery/kschedule/1.0/index",function(a,b,c,d,e,f){function g(b){var c=this;c.ctn=a.one(b.container),c.prev=a.one(b.prev),c.next=a.one(b.next),c.today=a.one(b.today),c.sw=b.showWeekend,c.rh=b.rowHeight||26,c.scrollTo=b.scrollTo||9,c.highlight=b.highlight||{from:9,to:18},c.save=b.save,c.read=b.read,c.delete=b.delete,c.update=b.update,c.scheduleform=new f,c.timer=null,c.set("days",7),c.set("msDay",864e5),c.set("halfHour",48),c.set("pxpermin",c.rh/30),g.superclass.constructor.call(c,b)}return b.all,a.extend(g,c,{render:function(){var a=this,b=new Date;a.sw||(a.set("days",5),a.set("colClass","col-wide")),a.monday=a.getMonday(b),a._createTable(),a.schedule=a.ctn.one(".J_ScheduleBox"),a.fields=a.ctn.one(".J_ScheduleContent"),a.thead=a.ctn.one(".J_ScheduleHeader"),a.tbody=a.ctn.one(".J_ScheduleBody"),a.side=a.ctn.one(".J_ScheduleSide"),a.line=a.ctn.one(".J_NowTime"),a.cols=a.fields.all(".c-col"),a.ths=a.thead.all(".h-days"),a._fixHeight(),a.today.attr("disabled",!0),a.gotoWeek(a.monday),a._setNowLine(),a._bindEvent(),a._openDrag(),a._formDelegate(),a._enableCreate()},gotoWeek:function(a){var b=this;b._updateHeader(a),b.read&&b._getSchedules(a)},getMonday:function(a){var b=this,c=a,d=a.getDay();return d=0==d?7:d,c=new Date(new Date(a.getFullYear(),a.getMonth(),a.getDate()).getTime()-(d-1)*b.get("msDay"))},fillDoub:function(a){return a=10>a?"0"+a:a},formatHour:function(a){var b=this,c=0,d=0;return c=b.fillDoub(Math.floor(a/60)),d=b.fillDoub(a%60),{h:c,m:d}},formatThead:function(a){var b=this,c=0,d=0,e=0,f=["\u65e5","\u4e00","\u4e8c","\u4e09","\u56db","\u4e94","\u516d"];return c=b.fillDoub(a.getFullYear()),d=b.fillDoub(a.getMonth()+1),e=b.fillDoub(a.getDate()),{y:c,m:d,d:e,w:f[a.getDay()]}},isToday:function(a){var b=new Date;return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()?!0:!1},hasToday:function(){var a=this,b=new Date,c=b.getTime()-a.monday.getTime();return c>=0&&c<7*a.get("msDay")?!0:!1},hideLine:function(){var a=this;clearTimeout(a.timer),a.line.css("display","none")},parseTime:function(a){var b=this,c=b.fillDoub(Math.floor(a/60)),d=b.fillDoub(a%60);return{h:c,m:d}},_formDelegate:function(){var b=this;b.scheduleform.overlay.delegate("click",".J_Update",function(c){var d=b.scheduleform.overlay.one(".J_FormElement"),e=d.attr("action");a.io({url:e,data:a.io.serialize(d),dataType:"jsonp",jsonp:"callback",success:function(a){a&&a.success&&(b.currentTarget.one(".text-box").html(a.schedule.content),b.currentTarget.one(".text-box").attr("title",a.schedule.content),b.scheduleform.hide())}}),c.halt()}),b.scheduleform.overlay.delegate("click",".J_Delete",function(c){var d=b.delete,e=b.scheduleform.overlay.one("input[name=id]").val();a.io({url:d,data:{id:e},dataType:"jsonp",jsonp:"callback",success:function(a){a&&a.success&&(b.currentTarget.remove(),b.scheduleform.setContent(""),b.scheduleform.hide())}}),c.halt()}),b.scheduleform.overlay.delegate("click",".J_Add",function(c){var d=b.scheduleform.overlay.one(".J_FormElement"),e=d.attr("action");a.io({url:e,data:a.io.serialize(d),dataType:"jsonp",jsonp:"callback",success:function(a){a&&a.success&&b._addSchedule(a)}}),c.halt()})},_addSchedule:function(a){var b=this;b.currentTarget.addClass("J_ScheduleBlock"),b.currentTarget.attr("data-id",a.id),b.currentTarget.one(".text-box").html(a.content),b.scheduleform.hide()},_parseTime:function(a,b,c,d){var e=this,f=null,g=null;return f=e.formatHour(30*a),g=e.formatHour(30*(parseInt(a)+d)),c.date=e.monday.getTime()+b*e.get("msDay"),c["start-time"]=f.h+":"+f.m,c["end-time"]=g.h+":"+g.m,c},_enableCreate:function(){var b=this,c={x:0,y:0},d={x:0,y:0},f={row:0,col:0},g={left:0,top:0},h=b.rh,i=b.get("colWidth")||a.one(b.cols[0]).outerWidth(),j=b.get("scheTpl").schedule,k=0,l={schedules:[]},m={id:"",date:"","start-time":"","end-time":"",content:"",style:""};b.fields.delegate("mousedown",".c-item",function(n){var o=a.one(n.target),p=b.fields.one(".J_ScheduleList");return b.currentTarget&&!b.currentTarget.hasClass("J_ScheduleBlock")&&b.currentTarget.remove(),b.scheduleform.hide(),c.x=n.clientX,c.y=n.clientY,f.row=parseInt(o.attr("row")),f.col=parseInt(o.attr("col")),k=0,g.left=f.col*i,g.top=f.row*h,g.height=0,g.width=i-5,l.schedules[0]=b._parseTime(f.row,f.col,m,k),b.currentTarget=a.one(a.DOM.create(new e(j).render(l))),b.currentTarget.removeClass("J_ScheduleBlock").addClass("schedule-new"),b.currentTarget.css(g),p?(p.append(b.currentTarget),b.fields.on("mousemove",function(a){d.x=a.clientX,d.y=a.clientY;var e=1,h=d.y-c.y,i=null;Math.abs(h)>b.rh/2&&(e=h>0?1:-1,k+=e,i=b._parseTime(f.row,f.col,m,k),g.height+=b.rh*e,b.currentTarget.css("height",g.height),b._writeNewSchedule(i),c.y+=b.rh*e)}),b.fields.on("mouseup",function(){b._editContent("add"),0===b.currentTarget.height()&&(b.currentTarget.remove(),b.scheduleform.hide()),b.fields.detach("mousemove mouseup")}),void 0):!1})},_writeNewSchedule:function(a){var b=this,c=b.currentTarget.one(".time-bar");b.currentTarget.attr("data-start",a["start-time"]),b.currentTarget.attr("data-end",a["end-time"]),c.html(a["start-time"]+" ~ "+a["end-time"])},_getSchedules:function(b){var c=this,d={monday:b.getTime(),days:c.get("days")};a.io({url:c.read,data:d,dataType:"jsonp",jsonp:"callback",success:function(a){a&&a.schedules&&a.schedules.length>0&&c._writeData(a)}})},_writeData:function(b){var c=this,d="",f=c.get("scheTpl").schedule,g=c.fields.one(".J_ScheduleList");g||(g=a.one(a.DOM.create('<div class="J_ScheduleList"></div>'))),g.html(""),a.each(b.schedules,function(b){var d=c._getCol(b.date),e=c._getRow(b["start-time"]),f=c._getHeight(b["start-time"],b["end-time"]),g=c.get("colWidth")||a.one(c.cols[0]).width(),h=d*g,i=e*c.rh;b.style="left:"+h+"px;top:"+i+"px;width:"+(g-5)+"px;height:"+f+"px"}),d=new e(f).render(b),g.html(d),c.fields.append(g)},_getCol:function(a){var b=this,c=parseInt(a)-b.monday,d=Math.floor(c/b.get("msDay"));return d},_getRow:function(a){var b=a.split(":"),c=60*parseInt(b[0])+parseInt(b[1]),d=c/30;return d},_getHeight:function(a,b){var c=this,d=a.split(":"),e=b.split(":"),f=60*parseInt(d[0])+parseInt(d[1]),g=60*parseInt(e[0])+parseInt(e[1]),h=g-f,i=h/30*c.rh;return i},_createTable:function(){for(var a=this,b={table:{header:'<li class="h-item h-empty"></li>',side:"",content:""}},c={header:{hItem:[]},side:{sItem:[]},content:{cItem:[]}},d="",f=[],g=0;g<a.get("halfHour");g++){var h='<span class="c-item c-item-odd{{highlight}}" row="'+g+'" col="{{col}}"></span>',i="s-item-odd";0===g%2&&(h='<span class="c-item c-item-even{{highlight}}" row="'+g+'" col="{{col}}"></span>',i="s-item-even"),h=g>=2*a.highlight.from&&g<2*a.highlight.to?h.replace(/\{\{highlight\}\}/g," c-working"):h.replace(/\{\{highlight\}\}/g,"");var j=a.formatHour(30*g);c.side.sItem.push({text:j.h+":"+j.m,rowCls:i}),f.push(h)}d=f.join("");for(var g=0;g<a.get("days");g++){var k=new Date(a.monday.getTime()+g*a.get("msDay")),l=a.isToday(k),m=a.formatThead(k);c.header.hItem.push({text:m.m+"\u6708"+m.d+"\u65e5\uff08"+m.w+"\uff09",today:l,colWidth:a.get("colClass")}),c.content.cItem.push({items:d.replace(/\{\{col\}\}/g,g),today:l,colWidth:a.get("colClass")})}var n=a.get("scheTpl");b.table.header+=new e(n.hItem).render(c.header),b.table.side+=new e(n.sItem).render(c.side),b.table.content+=new e(n.cItem).render(c.content);var o=new e(n.box).render(b);a.ctn.html(o)},_fixHeight:function(){var a=this,b=a.ctn.height(),c=a.thead.height(),d=2*a.scrollTo*a.rh;a.tbody.css({height:b-c,overflowX:"hidden",overflowY:"auto"}),a.thead.css({width:a.side.width()+a.fields.width()}),a.tbody.scrollTop(d)},_setNowLine:function(){var b=this,c=new Date,d=c.getDay(),e=60*c.getHours()+c.getMinutes(),f=b.get("pxpermin");d=0===d?7:d,d-=1;var g=a.one(b.cols[0]).width(),h=d*g,i=f*e-1;b.set("colWidth",g),d<b.get("days")?(b.line.css({display:"block",left:h,top:i,width:g}),b.timer=setTimeout(function(){b._setNowLine()},1e3)):b.hideLine()},_updateHeader:function(b){var c=this,d=(new Date).getDay();d=0===d?7:d,d-=1;var e=a.one(c.ths[d]),f=a.one(c.cols[d]);c.ths.each(function(a,d){var e=c.formatThead(new Date(b.getTime()+d*c.get("msDay")));a.html(e.m+"\u6708"+e.d+"\u65e5\uff08"+e.w+"\uff09")}),e&&(c.hasToday()?(e.addClass("h-today"),f.addClass("c-today")):(e.removeClass("h-today"),f.removeClass("c-today")))},_bindEvent:function(){var a=this;a.prev.on("click",function(){a.monday=new Date(a.monday.getTime()-7*a.get("msDay")),a.gotoWeek(a.monday),a.hasToday()?(a.today.attr("disabled",!0),a._setNowLine()):(a.today.removeAttr("disabled"),a.hideLine())}),a.next.on("click",function(){a.monday=new Date(a.monday.getTime()+7*a.get("msDay")),a.gotoWeek(a.monday),a.hasToday()?(a.today.attr("disabled",!0),clearTimeout(a.timer),a._setNowLine()):(a.today.removeAttr("disabled"),a.hideLine())}),a.today.on("click",function(){var b=new Date;a.monday=a.getMonday(b),a.gotoWeek(a.monday),a.today.attr("disabled",!0),clearTimeout(a.timer),a._setNowLine()})},_getMinutes:function(a){var b=a.split(":"),c=60*parseInt(b[0])+parseInt(b[1]);return c},_updateTime:function(a){var b=this,c=b.get("pxpermin"),d=b.currentTarget.one(".time-bar"),e=b._getMinutes(b.currentTarget.attr("data-start"))+a/c,f=b._getMinutes(b.currentTarget.attr("data-end"))+a/c,g=b.parseTime(e),h=b.parseTime(f);b.currentTarget.attr("data-start",g.h+":"+g.m),b.currentTarget.attr("data-end",h.h+":"+h.m),d.html(g.h+":"+g.m+" ~ "+h.h+":"+h.m)},_updateDate:function(a){var b=this,c=b.currentTarget.attr("data-date"),d=parseInt(c)+a*b.get("msDay");b.currentTarget.attr("data-date",d)},_isOutside:function(a,b){var c=this,d=0,e=0,f=c.fields.height()-c.currentTarget.height(),g=c.fields.width()-c.currentTarget.width();return"h"===b?e>a||a>g?!0:!1:"v"===b?d>a||a>f?!0:!1:void 0},_sendUpdate:function(b,c){var d=this;a.io({url:d.update,data:b,dataType:"jsonp",jsonp:"callback",success:function(a){a&&a.success||(d.currentTarget.attr("data-date",c.date),d.currentTarget.attr("data-start",c.stime),d.currentTarget.attr("data-end",c.etime),d.currentTarget.attr("style",c.style))}})},_openDrag:function(){var b=this,c={x:0,y:0},d={x:0,y:0},e=0,f={x:0,y:0},g=1,h=1;b.fields.delegate("mousedown",".J_ScheduleBlock",function(i){var j=a.one(i.target);j=j.hasClass(".J_ScheduleBlock")?j:j.parent(".J_ScheduleBlock");var k={date:j.attr("data-date"),stime:j.attr("data-start"),etime:j.attr("data-end"),style:j.attr("style")},l=j.css("left"),m=j.css("top");b.currentTarget&&!b.currentTarget.hasClass("J_ScheduleBlock")&&b.currentTarget.remove(),b.currentTarget=j,c.x=i.clientX,c.y=i.clientY,e=b._getMinutes(j.attr("data-end"))-b._getMinutes(j.attr("data-start")),b.fields.on("mousemove",function(a){if(d.x=a.clientX,d.y=a.clientY,f.x=d.x-c.x,f.y=d.y-c.y,Math.abs(f.y)>b.rh/2){g=f.y>0?1:-1;var e=g*b.rh,i=parseFloat(b.currentTarget.css("top"))+e;b._isOutside(i,"v")||(b.currentTarget.css("top",i),c.y+=e,b._updateTime(e))}if(Math.abs(f.x)>b.get("colWidth")/2){h=f.x>0?1:-1;var j=h*b.get("colWidth"),k=parseFloat(b.currentTarget.css("left"))+j;b._isOutside(k,"h")||(b.currentTarget.css("left",k),c.x+=j,b._updateDate(h))}}),b.fields.on("mouseup",function(){var a={},c=b.currentTarget.css("left"),d=b.currentTarget.css("top");l!=c||m!=d?(a.id=b.currentTarget.attr("data-id"),a.date=b.currentTarget.attr("data-date"),a.stime=b.currentTarget.attr("data-start"),a.etime=b.currentTarget.attr("data-end"),a.content=b.currentTarget.one(".text-box").html(),b._sendUpdate(a,k)):b._editContent("update"),b.fields.detach("mousemove mouseup")})})},_editContent:function(a){var b=this,c=b.get("formTpl"),d="",f={action:b.save,id:"",date:b.currentTarget.attr("data-date"),stime:b.currentTarget.attr("data-start"),etime:b.currentTarget.attr("data-end"),content:"",btns:c.add};"update"===a&&(f.action=b.update,f.id=b.currentTarget.attr("data-id"),f.content=b.currentTarget.one(".text-box").html(),f.btns=c.update+c.del),d=new e(c.form).render(f),b.scheduleform.setContent(d),b.scheduleform.showToTarget(b.currentTarget)}},{ATTRS:{colClass:{value:"col-narrow"},scheTpl:{value:{box:'{{#table}}<div class="J_ScheduleBox schedule-box"><ul class="J_ScheduleHeader schedule-header clearfix">{{{header}}}</ul><div class="J_ScheduleBody schedule-body clearfix"><div class="J_ScheduleSide schedule-side">{{{side}}}</div><div class="J_ScheduleContent schedule-content clearfix">{{{content}}}<div class="J_NowTime now-time"></div></div></div></div>{{/table}}',hItem:'{{#each hItem}}<li class="h-item h-days {{colWidth}}{{#if today}} h-today{{/if}}">{{text}}</li>{{/each}}',sItem:'{{#each sItem}}<span class="s-item {{rowCls}}">{{text}}</span>{{/each}}',cItem:'{{#each cItem}}<div class="c-col c-days {{colWidth}}{{#if today}} c-today{{/if}}">{{{items}}}</div>{{/each}}',schedule:'{{#each schedules}}<div class="J_ScheduleBlock schedule-block" data-id="{{id}}" data-date="{{date}}" data-start="{{start-time}}" data-end="{{end-time}}" style="{{style}}"><h3 class="time-bar">{{start-time}} ~ {{end-time}}</h3><div class="text-box" title="{{content}}">{{content}}</div></div>{{/each}}'}},formTpl:{value:{form:'<form class="J_FormElement form-element" action="{{action}}"><input type="hidden" name="id" value="{{id}}"><input type="hidden" name="date" value="{{date}}"><input type="hidden" name="stime" value="{{stime}}"><input type="hidden" name="etime" value="{{etime}}"><textarea class="schedule-main" name="content" row="6" col="60" placeholder="\u8bf7\u586b\u5199\u65e5\u7a0b\u5185\u5bb9">{{content}}</textarea><div class="J_OverlayAction overlay-action">{{{btns}}}</div></form>',update:'<input type="submit" class="J_Update btn btn-update" value="\u66f4\u65b0">',add:'<input type="submit" class="J_Add btn btn-add" value="\u4fdd\u5b58">',del:'<input type="button" class="J_Delete btn btn-delete" value="\u5220\u9664">'}}}}),g},{requires:["node","base","sizzle","xtemplate","./scheduleform"]});